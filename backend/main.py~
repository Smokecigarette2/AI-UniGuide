# backend/main.py

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import httpx

# ---------- НАСТРОЙКА GEMINI ЧЕРЕЗ HTTP ----------


GEMINI_API_KEY = "AIzaSyD0EtffPNd-z_G3cCzqdgUi_bO1qGkPjIY"

GEMINI_URL = (
    "https://generativelanguage.googleapis.com/v1beta/"
    "models/gemini-2.5-flash:generateContent"
)

# ---------- FASTAPI ----------

app = FastAPI(title="AI-UniGuide backend")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],   # для хакатона нормально
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


class AskRequest(BaseModel):
    question: str
    universityId: str | None = None


class AskResponse(BaseModel):
    answer: str


@app.get("/")
async def root():
    return {"status": "ok"}


@app.post("/api/ask", response_model=AskResponse)
async def ask_ai(req: AskRequest):
    # Контекст для модели
    prompt = (
        "Ты — AI-помощник по выбору университетов Казахстана. "
        "Отвечай кратко и по делу, максимум 4–5 предложений.\n\n"
        f"Вопрос пользователя: {req.question}"
    )

    payload = {
        "contents": [
            {
                "parts": [
                    {"text": prompt}
                ]
            }
        ]
    }

    headers = {
        "x-goog-api-key": GEMINI_API_KEY,
        "Content-Type": "application/json",
    }

    try:
        async with httpx.AsyncClient(timeout=20.0) as client:
            resp = await client.post(
                GEMINI_URL,
                headers=headers,
                json=payload,
            )

        resp.raise_for_status()
        data = resp.json()

        # Достаём текст ответа
        answer = data["candidates"][0]["content"]["parts"][0]["text"].strip()

    except Exception as e:
        print("Gemini error:", repr(e))
        answer = "Не получилось получить ответ от AI."

    return AskResponse(answer=answer)
