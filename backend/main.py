# backend/main.py

import os

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import httpx

# ---------- НАСТРОЙКА GEMINI ЧЕРЕЗ HTTP ----------

# пока храним ключ прямо в коде (репозиторий держи приватным)
GEMINI_API_KEY = "KEY"

# ВАЖНО: используем v1, не v1beta
GEMINI_URL = (
    "https://generativelanguage.googleapis.com/v1/"
    "models/gemini-1.5-flash:generateContent"
)

# ---------- ЛОКАЛЬНАЯ БАЗА ПО NARXOZ ----------

NARXOZ_FACTS = [
    "Приёмная комиссия Narxoz University в основной период работы находится в главном корпусе, кабинет 102.",
    "Консультации по вопросам поступления на бакалавриат проходят в кабинете 104 с 9:00 до 18:00 по будням.",
    "Академический офис бакалавриата расположен в кабинете 215 главного корпуса.",
    "Академический офис магистратуры и PhD находится в кабинете 312.",
    "Касса университета и отдел оплаты обучения расположены на первом этаже, кабинет 110.",
    "Центр карьерного развития находится в кабинете 210 и помогает студентам с поиском стажировок.",
    "Учебные аудитории с номерами 100–199 находятся на первом этаже главного корпуса.",
    "Аудитории 200–299 находятся на втором этаже, в том числе большие лекционные залы.",
    "Аудитории 300–399 расположены на третьем этаже и чаще всего используются для семинаров.",
    "Компьютерные лаборатории по цифровым технологиям находятся в аудиториях 220, 221 и 222.",
    "Библиотека Narxoz University расположена в отдельном крыле второго этажа.",
    "Читальный зал библиотеки работает с 9:00 до 21:00 по будням и с 10:00 до 18:00 по субботам.",
    "В библиотеке есть тихая зона для самостоятельной работы и открытые пространства для групповых проектов.",
    "Студенческий коворкинг с розетками и Wi-Fi находится на первом этаже рядом с кафетерием.",
    "Студенческое общежитие Narxoz располагается в пешей доступности от кампуса и имеет несколько блоков.",
    "Заселение в общежитие проводится через отдел по работе со студентами, кабинет 205.",
    "Для получения места в общежитии приоритет отдается студентам из регионов и льготным категориям.",
    "Учебный год делится на осенний и весенний семестры, каждый примерно по 15 учебных недель.",
    "Экзаменационная сессия проходит в конце каждого семестра и длится 2–3 недели.",
    "Большинство дисциплин по бакалавриату оцениваются по буквенной системе A–F с пересчётом в GPA.",
    "Для успешного завершения курса студент должен набрать не менее 50% от максимального количества баллов.",
    "Промежуточный контроль включает два рубежных контроля и текущие задания в течение семестра.",
    "Экзамен по дисциплине обычно занимает 60–90 минут и проводится в компьютерных или обычных аудиториях.",
    "Дополнительная пересдача экзамена возможна при уважительных причинах и по заявлению студента.",
    "При академической задолженности студент обязан закрыть долги в течение следующего семестра.",
    "Минимальный проходной балл ЕНТ на госгрант в Narxoz University для большинства программ составляет около 100 баллов.",
    "Для программ «Социальная работа» и близких гуманитарных направлений пороговый балл на грант может начинаться примерно с 80 баллов.",
    "Для программ «Политология», «Право» и «Международные отношения» минимальный балл на грант обычно выше — около 90 и более.",
    "На платное обучение в Narxoz University, как правило, достаточно набрать около 70 баллов по ЕНТ.",
    "При поступлении в колледж при Narxoz сертификат ЕНТ не обязателен, абитуриенты могут проходить внутренние испытания.",
    "Помимо общего балла ЕНТ учитываются профильные предметы, важные для выбранной образовательной программы.",
    "Для части программ с обучением на английском языке может потребоваться подтверждение уровня английского не ниже B2.",
    "Абитуриенты, поступающие на программы с английским языком обучения, могут сдавать внутренний тест по английскому.",
    "Часть программ Narxoz предоставляет скидки на обучение для абитуриентов с высоким баллом ЕНТ.",
    "Размер скидки может зависеть от суммарного балла ЕНТ, среднего балла аттестата и участия в олимпиадах.",
    "Студенты с высоким GPA могут претендовать на повышенные академические стипендии.",
    "В университете действуют социальные стипендии и материальная помощь для студентов из уязвимых категорий.",
    "Учебный процесс в Narxoz строится на сочетании лекций, семинаров, кейс-стади и проектной работы.",
    "На экономических и бизнес-направлениях студенты регулярно решают реальные кейсы компаний Казахстана.",
    "Во многих дисциплинах значительную часть оценки составляют групповые проекты и презентации.",
    "В Narxoz действует система электронной образовательной среды, где размещаются задания, лекции и оценки.",
    "Студенты могут отслеживать расписание занятий и экзаменов через личный кабинет в онлайн-системе.",
    "Международный офис Narxoz консультирует по программам обмена и двойных дипломов с зарубежными вузами.",
    "Студенты могут участвовать в академической мобильности и проходить один или два семестра за рубежом.",
    "В Narxoz работают студенческие клубы по финансам, маркетингу, дебатам, IT и другим направлениям.",
    "Для записи на факультативы и майнор-программы студенты подают онлайн-заявку в начале семестра.",
    "В кампусе действует правило посещаемости: пропуски без уважительной причины могут снизить итоговую оценку.",
    "Нарушение академической честности (списывание, плагиат) может привести к аннулированию работы.",
    "Официальные языки делопроизводства университета — казахский и русский, но многие курсы ведутся на английском.",
    "Для связи с деканатом студенты могут использовать корпоративную почту и личные обращения в приёмные часы."
]

# ---------- FASTAPI ----------

app = FastAPI(title="AI-UniGuide backend")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


class AskRequest(BaseModel):
    question: str
    universityId: str | None = None


class AskResponse(BaseModel):
    answer: str


@app.get("/")
async def root():
    return {"status": "ok"}


@app.post("/api/ask", response_model=AskResponse)
async def ask_ai(req: AskRequest):
    # Если вопрос про Narxoz — подмешиваем локальную базу фактов
    if req.universityId == "narxoz":
        context = "\n".join(f"• {fact}" for fact in NARXOZ_FACTS)
        prompt = (
            "Ты — AI-гид по Narxoz University в Алматы. "
            "Отвечай по-русски, опираясь только на факты из базы ниже. "
            "Если точного ответа нет, честно скажи, что такой информации нет в базе "
            "и посоветуй обратиться в приёмную комиссию.\n\n"
            f"БАЗА ФАКТОВ:\n{context}\n\n"
            f"Вопрос пользователя: {req.question}"
        )
    else:
        # Общий помощник по вузам
        prompt = (
            "Ты — AI-помощник по выбору университетов Казахстана. "
            "Отвечай кратко и по делу, максимум 4–5 предложений.\n\n"
            f"Вопрос пользователя: {req.question}"
        )

    payload = {
        "contents": [
            {
                "parts": [
                    {"text": prompt}
                ]
            }
        ]
    }

    headers = {
        "x-goog-api-key": GEMINI_API_KEY,
        "Content-Type": "application/json",
    }

    try:
        async with httpx.AsyncClient(timeout=20.0) as client:
            resp = await client.post(
                GEMINI_URL,
                headers=headers,
                json=payload,
            )

        resp.raise_for_status()
        data = resp.json()
        answer = data["candidates"][0]["content"]["parts"][0]["text"].strip()

    except Exception as e:
        # Очень полезно видеть, ЧТО именно пошло не так
        print("Gemini error:", repr(e))
        answer = "Не получилось получить ответ от AI."

    return AskResponse(answer=answer)
